<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>拼豆订单信息收集</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #218838;
        }
        .error {
            color: red;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
    <!-- 引入 ExcelJS 和 FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- 引入 EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // 初始化 EmailJS
        (function () {
            emailjs.init('QKic_kMiOq4Jhee_S'); // 替换为您的 EmailJS User ID
        })();
    </script>
</head>
<body>
    <div class="container" id="page1">
        <h1>拼豆订单信息收集</h1>
        <div class="form-group">
            <label for="orderNumber">订单号</label>
            <input type="text" id="orderNumber" placeholder="请输入订单号">
        </div>
        <div class="form-group">
            <label for="customerName">客户姓名</label>
            <input type="text" id="customerName" placeholder="请输入客户姓名">
        </div>
        <div class="form-group">
            <label for="customerPhone">客户电话</label>
            <input type="text" id="customerPhone" placeholder="请输入客户电话">
        </div>
        <button class="btn" onclick="submitOrder()">提交订单</button>
    </div>

    <script>
        // 检查输入数据
        function checkInputData() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();

            if (!orderNumber || !customerName || !customerPhone) {
                alert('请填写完整订单信息！');
                return false;
            }
            return true;
        }

        // 生成 Excel 文件
        async function generateExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('订单信息');

            // 添加表头
            worksheet.columns = [
                { header: '订单号', key: 'orderNumber', width: 20 },
                { header: '客户姓名', key: 'customerName', width: 20 },
                { header: '客户电话', key: 'customerPhone', width: 20 }
            ];

            // 添加数据
            worksheet.addRow({
                orderNumber: document.getElementById('orderNumber').value.trim(),
                customerName: document.getElementById('customerName').value.trim(),
                customerPhone: document.getElementById('customerPhone').value.trim()
            });

            // 生成文件
            const buffer = await workbook.xlsx.writeBuffer();
            return buffer;
        }

        // 发送邮件
        async function sendEmail(fileName, base64Data) {
            const emailParams = {
                to_email: '1069667544@qq.com', // 替换为客服邮箱
                from_name: '拼豆订单系统',
                subject: `新订单：${document.getElementById('orderNumber').value.trim()}`,
                message: `订单号：${document.getElementById('orderNumber').value.trim()} 的 Excel 文件已生成，请查收附件。`,
                attachment: {
                    name: fileName,
                    data: base64Data
                }
            };

            try {
                await emailjs.send('YOUR_EMAILJS_SERVICE_ID', 'service_u770rkn', emailParams); // 替换为您的 Service ID 和 Template ID
                alert('邮件发送成功！');
            } catch (error) {
                alert('邮件发送失败，请稍后重试。');
                console.error('邮件发送错误：', error);
            }
        }

        // 提交订单
        async function submitOrder() {
            if (!checkInputData()) return;

            const confirmSubmit = confirm('确认提交？');
            if (!confirmSubmit) return;

            // 生成 Excel 文件
            const buffer = await generateExcel();
            const base64Data = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            const fileName = `订单_${document.getElementById('orderNumber').value.trim()}.xlsx`;

            // 发送邮件
            await sendEmail(fileName, base64Data);
        }
    </script>
</body>
</html>
